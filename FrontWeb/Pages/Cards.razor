@page "/cards"

@using SamaCardAll.Infra.Models

@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime;

<h3>Cards</h3>

<button class="btn btn-primary" @onclick="() => OpenModal()">New Card</button>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Bank</th>
            <th>Number</th>
            <th>Expiration</th>
            <th>Brand</th>
            <th>Active</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var card in _cards)
        {
            <tr>
                <td>@card.IdCard</td>
                <td>@card.Bank</td>
                <td>@card.Number</td>
                <td>@card.Expiration</td>
                <td>@card.Brand</td>
                <td>
                    <input type="checkbox" id="cardActive" checked="@(card.Active == 1)" readonly />
                </td>
                <td>
                    <!-- Action buttons for editing/deleting -->
                    <button class="btn btn-primary" @onclick="() => EditCard(card)">Edit</button>
                    <button class="btn btn-danger" @onclick="() => DeleteCard(card)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<ModalDialog @ref="@modalDialog" Title="Edit Card">
    <EditCardForm Model="card" OnValidSubmit="HandleValidSubmit"/>
</ModalDialog>

@code {

    [Parameter]
    public EventCallback OnValidSubmit { get; set; }

    private Card card = new Card();

    private ModalDialog modalDialog { get; set; }
    private EditCardForm editCardForm { get; set; }
    private List<Card> _cards = new List<Card>();


    private async void HandleValidSubmit()
    {
        //OnValidSubmit.InvokeAsync();
        await SaveCard();
    }

    protected override async Task OnInitializedAsync()
    {
        _cards = await HttpClient.GetFromJsonAsync<List<Card>>("/api/Card");
    }

    private void OpenModal(Card cardToEdit = null)
    {
        if (cardToEdit != null)
        {
            this.card = cardToEdit;
        }
        else
        {
            this.card = new Card();
        }

        modalDialog.Open();
    }

    async Task SaveCard()
    {
        if (card == null)
        {
            return;
        }

        if (card.IdCard == 0)
        {
            // New card, use POST
            var response = await HttpClient.PostAsJsonAsync<Card>($"/api/Card/", card);
            if (response.IsSuccessStatusCode)
            {
                // Refresh the card list
                _cards = await HttpClient.GetFromJsonAsync<List<Card>>("/api/Card");
                modalDialog.Close();
            }
        }
        else
        {
            // Existing card, use PUT for update
            var response = await HttpClient.PutAsJsonAsync<Card>($"/api/Card/{card.IdCard}", card);
            if (response.IsSuccessStatusCode)
            {
                // Refresh the card list
                _cards = await HttpClient.GetFromJsonAsync<List<Card>>("/api/Card");
                modalDialog.Close();
            }
        }

        // Reset the card object after the operation
        card = null;
    }

    private void EditCard(Card card)
    {
        OpenModal(card);
    }

    private async Task DeleteCard(Card card)
    {
        var confirmDelete = await JSRuntime.InvokeAsync<bool>("confirm", new object?[] { "Are you sure you want to delete this card?" });

        if (confirmDelete)
        {
            var response = await HttpClient.DeleteAsync($"/api/Card/{card.IdCard}");
            if (response.IsSuccessStatusCode)
            {
                // Remove the card from the list
                _cards.Remove(card);
            }
        }
    }

}